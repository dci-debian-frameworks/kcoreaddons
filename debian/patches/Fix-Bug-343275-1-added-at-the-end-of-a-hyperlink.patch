From: Montel Laurent <montel@kde.org>
Date: Wed, 23 Nov 2016 08:07:25 +0100
Subject: Fix Bug 343275 - [1] added at the end of a hyperlink

FIXED-IN: 5.29
BUG: 343275
---
 autotests/ktexttohtmltest.cpp | 5 +++++
 src/lib/text/ktexttohtml.cpp  | 6 ++++++
 2 files changed, 11 insertions(+)

diff --git a/autotests/ktexttohtmltest.cpp b/autotests/ktexttohtmltest.cpp
index ccac29a..f48a31c 100644
--- a/autotests/ktexttohtmltest.cpp
+++ b/autotests/ktexttohtmltest.cpp
@@ -411,6 +411,11 @@ void KTextToHTMLTest::testHtmlConvert_data()
    QTest::newRow("url-exec-html-6") << "https://<IP>:/\"><script>alert(1);</script><!--\nTest2"
                                << KTextToHTML::Options(KTextToHTML::PreserveSpaces)
                                << "https://&lt;IP&gt;:/&quot;&gt;&lt;script&gt;alert(1);&lt;/script&gt;&lt;!--\nTest2";
+
+
+   QTest::newRow("url-with-ref-in-[") << "https://www.kde.org[1]"
+                               << KTextToHTML::Options(KTextToHTML::PreserveSpaces)
+                               << "<a href=\"https://www.kde.org\">https://www.kde.org</a>[1]";
 }
 
 
diff --git a/src/lib/text/ktexttohtml.cpp b/src/lib/text/ktexttohtml.cpp
index 30e0b5d..ecc1d22 100644
--- a/src/lib/text/ktexttohtml.cpp
+++ b/src/lib/text/ktexttohtml.cpp
@@ -229,12 +229,15 @@ QString KTextToHTMLHelper::getUrl(bool *badurl)
         int start = mPos;
         bool previousCharIsSpace = false;
         bool previousCharIsADoubleQuote = false;
+        bool previousIsAnAnchor = false;
         while ((mPos < mText.length()) &&
                 (mText[mPos].isPrint() || mText[mPos].isSpace()) &&
                 ((afterUrl.isNull() && !mText[mPos].isSpace()) ||
                  (!afterUrl.isNull() && mText[mPos] != afterUrl))) {
             if (mText[mPos].isSpace()) {
                 previousCharIsSpace = true;
+            } else if (!previousIsAnAnchor && mText[mPos] == QLatin1Char('[')) {
+                break;
             } else { // skip whitespace
                 if (previousCharIsSpace && mText[mPos] == QLatin1Char('<')) {
                     url.append(QLatin1Char(' '));
@@ -253,6 +256,9 @@ QString KTextToHTMLHelper::getUrl(bool *badurl)
                 } else {
                     previousCharIsADoubleQuote = false;
                 }
+                if (mText[mPos] == QLatin1Char('#')) {
+                    previousIsAnAnchor = true;
+                }
                 url.append(mText[mPos]);
                 if (url.length() > mMaxUrlLen) {
                     break;
